## Геокодирование адресов Москвы по данным OpenStreetMap

### Описание проекта

Система геокодирования адресов для города Москва на основе данных OpenStreetMap.
По текстовому адресу (полные и неполные формы) система находит здания и возвращает
их координаты и оценку релевантности.

Реализованы:
- **базовый алгоритм** — быстрый поиск по точному/почти точному совпадению улицы и дома;
- **улучшенный алгоритм** — нечеткий поиск + нормализация + ML‑скоринг (логистическая регрессия).

Система ориентирована на:
- устойчивость к опечаткам и вариациям формата адреса;
- адекватное ранжирование нескольких кандидатов;
- воспроизводимую оценку качества (по тексту + координатам).

---

## Структура проекта

```text
rwb/
├── data/
│   ├── central-fed-district-251113.osm.pbf   # Исходный PBF (ЦФО, от организаторов)
│   ├── buildings.osm.pbf                     # PBF с building=* (можно пересоздать)
│   └── moscow_buildings.geojson              # Итоговый слой зданий Москвы
├── src/
│   ├── __init__.py
│   ├── address_normalizer.py                 # Нормализация и парсинг адресов (FIAS‑подобные правила)
│   ├── geocoder_base.py                      # Базовый геокодер
│   ├── geocoder_advanced.py                  # Улучшенный геокодер с ML‑скорингом
│   ├── metrics.py                            # Метрики по тексту и координатам
│   ├── api.py                                # REST API (FastAPI)
│   ├── osm_parser.py                         # Обёртка для работы с PBF (через osmium-tool)
│   ├── process_large_geojson.py              # Чанковая обработка больших GeoJSON
│   ├── process_osm_data.py                   # Скрипт полного пайплайна обработки данных
│   ├── example_usage.py                      # Демонстрация base/advanced в Python
│   ├── evaluate_geocoder.py                  # Оценка метрик на 100 адресах
│   ├── train_scoring_model.py                # Оффлайн обучение логистической модели скоринга
│   └── train_scoring_catboost.py             # Эксперимент с CatBoost (бустинг, в итоге не используем)
├── convert_optimized.sh                      # Скрипт PBF → GeoJSON с фильтрацией Москвы
├── CONVERT_OSM.md                            # Подробная инструкция по конвертации/фильтрации OSM
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
└── README.md
```

---

## Установка и запуск

### Локальный запуск

1. **Виртуальное окружение (рекомендуется):**

```bash
python3 -m venv venv
source venv/bin/activate
```

2. **Установка зависимостей:**

```bash
python3 -m pip install --upgrade pip
pip install -r requirements.txt
```

3. **Подготовка данных (здания Москвы):**

- **Вариант A — использовать готовый GeoJSON:**

  Поместите файл с подготовленными зданиями Москвы в:

  ```text
  data/moscow_buildings.geojson
  ```

- **Вариант B — собрать слой из PBF с помощью `convert_optimized.sh`:**

  1) Установите `osmium-tool`:

  ```bash
  # macOS
  brew install osmium-tool

  # Linux
  sudo apt-get install osmium-tool
  ```

  2) Убедитесь, что в `data/` лежит исходный PBF:

  ```text
  data/central-fed-district-251113.osm.pbf
  ```

  3) Запустите:

  ```bash
  ./convert_optimized.sh
  ```

  После успешного завершения в `data/moscow_buildings.geojson` будет готовый слой зданий Москвы.

  Детали альтернативных сценариев (QGIS, ogr2ogr и т.п.) описаны в `CONVERT_OSM.md`.

4. **Запуск REST API:**

```bash
uvicorn src.api:app --host 0.0.0.0 --port 8000
```

Проверка:

```bash
curl http://localhost:8000/health
```

### Запуск в Docker

```bash
docker-compose up --build
```

---

## API

### Эндпоинт геокодирования

- **POST** `/geocode`
- **Тело запроса:**

```json
{
  "address": "Москва, ул. Тверская, д. 10",
  "algorithm": "advanced",
  "max_results": 5
}
```

- **Пример ответа:**

```json
{
  "searched_address": "Москва, ул. Тверская, д. 10",
  "objects": [
    {
      "locality": "Москва",
      "street": "Тверская улица",
      "number": "10",
      "lon": 37.6085,
      "lat": 55.7630,
      "score": 0.81
    },
    {
      "locality": "Москва",
      "street": "Тверская улица",
      "number": "10",
      "lon": 37.6085,
      "lat": 55.7630,
      "score": 0.81
    },
    {
      "locality": "Бачурино",
      "street": "Тюляевская",
      "number": "10",
      "lon": 37.5081,
      "lat": 55.5710,
      "score": 0.77
    }
  ]
}
```

---

## Используемые данные и шаги предобработки

### Исходные данные
- PBF файл Центрального Федерального округа из OpenStreetMap (`central-fed-district-251113.osm.pbf`)
- Содержит геоданные о зданиях, улицах и адресных атрибутах

### Предобработка данных

1. **Загрузка OSM данных**: конвертация PBF файла в GeoJSON с помощью готовых инструментов (osmium-tool, QGIS) или использование предобработанных данных
2. **Извлечение зданий**: фильтрация объектов с типом `building`
3. **Фильтрация по географии**: отбор зданий в границах Москвы (55.5-55.9°N, 37.3-37.9°E)
4. **Извлечение адресных атрибутов**:
   - `addr:city` → `locality`
   - `addr:street` → `street`
   - `addr:housenumber` → `number`
5. **Фильтрация по полноте данных**: оставляем только здания с указанными улицей и номером дома
6. **Нормализация адресов**: приведение к единому формату с учетом классификатора FIAS
7. **Сохранение в GeoJSON**: для быстрой загрузки при работе API

### Нормализация адресов

Нормализация включает:
- Приведение к нижнему регистру
- Удаление лишних пробелов
- Обработка сокращений согласно классификатору FIAS (https://www.alta.ru/fias/socrname/)
- Парсинг компонентов адреса (населенный пункт, улица, номер дома)

## Эксперименты

### Эксперимент 1: Базовый алгоритм

**Подход**: Простое точное совпадение компонентов адреса без продвинутой обработки текста.

**Реализация**:
- Нормализация входного адреса и адресов в базе данных
- Точное совпадение улицы и номера дома
- При отсутствии точных совпадений - частичное совпадение по улице
- Возврат всех найденных объектов с score=1.0

**Особенности**:
- Быстрый поиск за счет простой индексации
- Требует точного совпадения компонентов
- Не обрабатывает опечатки и вариации написания

### Эксперимент 2: Улучшенный алгоритм

**Подход**: Использование нечетких метрик, нормализаций и индексации.

**Реализация**:
- Нечеткий поиск улиц с использованием расстояния Левенштейна (библиотека `rapidfuzz`)
- Пространственная индексация с помощью R-tree для быстрого поиска по координатам
- Нормализация всех компонентов адреса
- Вычисление релевантности (score) на основе:
  - Схожести улицы (вес 70%)
  - Схожести номера дома (вес 30%)
- Ранжирование результатов по убыванию score

**Дополнительные возможности**:
- Функция `geocode_with_location_hint()` для учета геолокации при отборе кандидатов
- Настраиваемые пороги схожести
- Возврат множественных результатов с оценкой релевантности

**Преимущества**:
- Обрабатывает опечатки и вариации написания
- Более гибкий поиск
- Ранжирование результатов по релевантности

## Метрики оценки качества

### Метрика по тексту адреса

Используется нормированная схожесть на основе расстояния Левенштейна:

```
score = 1 - L(A_pred, A_true) / max(len(A_pred), len(A_true))
```

где:
- `A_pred` - нормализованный предсказанный адрес
- `A_true` - нормализованный эталонный адрес
- `L(x, y)` - расстояние Левенштейна между строками

Значение 1 означает полное совпадение, 0 - максимальное различие.

### Метрика по координатам

Вычисляется расстояние между предсказанными и эталонными координатами:
- Расстояние в метрах (используется библиотека `geopy`)
- Нормализованный score с экспоненциальным затуханием:
  ```
  score = 1.0 - (distance / max_distance)
  ```

### Комбинированная метрика

Взвешенная сумма текстовой и координатной метрик:
```
combined_score = text_weight * text_score + coord_weight * coord_score
```

По умолчанию: `text_weight = 0.5`, `coord_weight = 0.5`

## Примеры использования

### Через Python API

```python
import geopandas as gpd
from src.geocoder_advanced import AdvancedGeocoder

# Загрузка данных
buildings = gpd.read_file("data/moscow_buildings.geojson")

# Инициализация геокодера
geocoder = AdvancedGeocoder(buildings)

# Геокодирование
results = geocoder.geocode("Москва, ул. Тверская, д. 10")
```

### Через REST API

```bash
curl -X POST "http://localhost:8000/geocode" \
  -H "Content-Type: application/json" \
  -d '{
    "address": "Москва, ул. Тверская, д. 10",
    "algorithm": "advanced",
    "max_results": 5
  }'
```

### Запуск примера

```bash
python src/example_usage.py
```

## Структура проекта

```
rwb/
├── data/                          # Обработанные данные
│   └── moscow_buildings.geojson   # Извлеченные здания Москвы
├── src/
│   ├── __init__.py
│   ├── osm_parser.py              # Парсер OSM PBF файлов
│   ├── address_normalizer.py      # Нормализация адресов
│   ├── geocoder_base.py           # Базовый алгоритм
│   ├── geocoder_advanced.py       # Улучшенный алгоритм
│   ├── metrics.py                 # Метрики оценки
│   ├── api.py                     # REST API сервис
│   ├── process_osm_data.py         # Скрипт обработки данных
│   └── example_usage.py           # Примеры использования
├── central-fed-district-251113.osm.pbf  # Исходные данные OSM
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
└── README.md
```

## Технические детали

### Используемые библиотеки
- **geopandas**: работа с геоданными (загрузка предобработанных GeoJSON файлов)
- **rapidfuzz**: нечеткий поиск и расстояние Левенштейна
- **rtree**: пространственная индексация
- **fastapi**: REST API фреймворк
- **geopy**: вычисление расстояний между координатами

### Производительность
- Базовый алгоритм: быстрый поиск за счет простой индексации
- Улучшенный алгоритм: оптимизирован с помощью R-tree индекса и кэширования нормализованных адресов

## Авторы

[Ваше имя/команда]

